---
layout: post
title: "Amazon IoT Button"
excerpt: "Touch and it talks for you"
tags: [AWS, Lambda, IoT]
image:
# pic silver robot white skin handshake 1900x500
  feature: https://cloud.githubusercontent.com/assets/300046/14622149/306629f0-0585-11e6-961a-dc8f60dadbf6.jpg
  credit: 
  creditlink: 
comments: true
---
<i>{{ page.excerpt }}</i>

{% include _toc.html %}

This article contains my notes about hooking up sensors to 
Amazon's IoT (Internet of Things) cloud services.
This makes use of AWS "real" and fun, especially for kinesthetic learners.

{% include _intro.html %}


## Lowest cost IoT #

Amazon provides perhaps the lowest-cost IoT device: a
<a target="_blank" href="https://www.amazon.com/dp/B01C7WE5WM">
$19.95</a>
<a target="_blank" href="https://aws.amazon.com/iot/button/">
Limited Release Programmable AWS IoT Button</a>.
Mine came August 3, 2016.
The AWS IoT Button first made its appearance October of 2015 as a gift to Amazon's re:Invent convention attendees. 

<a target="_blank" href="https://www.amazon.com/Amazon-JK29LP-Trojan-Dash-Button/dp/B01C3JBA7M/">
<img align="right" alt="aws-iot trojan button 20180810-168x196-i11.png" width="168" height="196" src="https://cloud.githubusercontent.com/assets/14143059/17570835/3a85c744-5f0b-11e6-99fa-60aaf46ea549.jpg"></a>
Its price is actually steep compared with the brand-name Dash buttons from Amazon such as
<a target="_blank" href="https://www.amazon.com/Amazon-JK29LP-Trojan-Dash-Button/dp/B01C3JBA7M/">
this</a>.
They're "free" (for Prime members) in that after you buy one for $4.99, 
you receive a credit for the same amount with your first purchase using it.
(Hold on while waiting for it to arrive)

NOTE: <a target="_blank" href="https://www.youtube.com/watch?v=orXM2HCXYRI">
this guy</a> brags he re-purposed the Dash by intercepting its ARP request, but doesn't show how.
The device uses port 8443.
   <a target="_blank" href="http://portquiz.net:8443/">
   Click here to test if it's open on your network</a>.

BTW, Amazon also has a 
<a target="_blank" href="https://www.amazon.com/Amazon-Dash-quick-easy-shop/dp/B00GMSIHOU/">
$50 wand</a> to scan barcodes
and listen to you begging for stuff.
An Apple/Android phone is needed to activate the device. 

For bulk orders with custom artwork, use <a target="_blank" href="https://aws.amazon.com/blogs/aws/introducing-the-aws-iot-button-enterprise-program/">
Amazon's Enterprise IOT program</a> (since January 2017)


## Other buttons #

If you want additional capability in a button,
look at the <a target="_blank" href="https://www.particle.io/products/hardware/internet-button">
$49 "Internet Button" from Particle.io</a>. 
It uses the same <a target="_blank" href="https://www.broadcom.com/products/wireless-connectivity/wireless-lan/bcm943362wcd4">
Broadcom</a> 802.11b/g/n wi-fi chip as in Amazon Dash, Nest Protect, and LIFX.
It has 4 tactile (directional) buttons to issue outbound events, 
and receives inputs to control 11 RGB LEDs, plus a
ADXL362 3-axis accelerometer.
All without any wires or soldering.

Kwik (lock makers)
<a target="_blank" href="https://techcrunch.com/2016/06/21/kwik-raises-3-million-to-take-on-amazon-dash-buttons/">
is also making IoT buttons</a>.

<a target="_blank" href="https://flic.io/">Flic.io</a>
offers four buttons for $99. They may be worth $25 each if you consider that
they are powered by <strong>repleaceable</strong> watch batteries,
and connect via Bluetooth to their <a target="_blank" href="https://start.flic.io/">
mobile apps</a> (by Shortcut Labs AB). So no nerdy setup like AWS requires.
Their buttons also have a removeable sticky film that's removeable for cleaning.
However, this puts the buttons within a closed ecosystem.
To choose an action, Click, Double click, and Hold.
(Too bad it doesn't act like a locator beacon as well)


## Signal Range #

QUIZ: Which type of transmission has further range? Bluetooth or WiFi?

The standard range of "class 1" Bluetooth devices (transmitting at 100mW)
is about 100 meters or <strong>328 feet</strong>, 
which is comparable to that of an 802.11b WLAN device. 

A typical wireless router in an indoor point-to-multipoint arrangement using 802.11n 
and a stock antenna might have a range of <strong>32 metres (105 ft)</strong>.


## Battery life #

As with any electronics, the current limitation is battery life
and hassles with charging.

WARNING: Amazon's Dash button uses <strong>wi-fi</strong> (2.4 Ghz) so its battery may not last as long as
other buttons using Bluetooth Low Energy data transmission.

PROTIP: Battery status (remaining voltage) is sent to Amazon every time you press their button.
When the device battery runs out of charge, there is no way to recharge or replace the battery.
The battery on first-generation buttons is rated to last for 1,000 presses. That's over 2 years if you press it once a day.
2nd generation buttons are rated at 2,000 presses.

<a target="_blank" href="https://www.youtube.com/watch?v=rMiplPiU2nI&t=1m26s">
This teardown video</a> shows Dash buttons contain an Energizer brand AAA Lithium battery.

The brains of the 1st gen. Dash button is a 32-bit, 120MHz 64-pin ARM Cortex M3 microprocessor
from <a target="_blank" href="http://www.st.com/web/en/resource/technical/document/reference_manual/CD00225773.pdf">
ST Microelectronics (STM32F205RG6)</a>,
containing 128 KB of RAM, 1 MB of flash memory, and 16 MB of 
<a target="_blank" href="http://ww1.microchip.com/downloads/en/DeviceDoc/25044A.pdf">
SPI flash</a>.


## Sample single-button tricks #

* <a target="_blank" href="https://www.hackster.io/amazonwebservices/products/aws-iot-button">
   Hackster.io AWS IoT button starter project</a>

* This bathroom needs attention, Yuck!

   PROTIP: The trouble with any re-programmable unit is there is incentive for it to be stolen.
   But (at $5) is the worth the $500 it take to put it behind a wall?

* Honey I'm home! <a target="_blank" href="https://www.hackster.io/reanimationxp/amazon-re-invent-dash-button-aws-ifttt-infinibutton-daaf5d?ref=part&ref_id=13747&offset=0">
   Send a signal</a> to <a target="_blank" href="https://ifttt.com/maker">IFTTT.com's Maker Channel</a>,
   though which you can specify all manner of actions (send voicemail, SMS text, Skype, etc.).
   <a href="#IFTTT">Setup instructions below</a>.

* "Panic" button. Press it and it sends an SMS text to configured phone numbers.
   As in http://www.epanicbutton.com/

* Track task (chore) completion time so if it's not done <strong>a reminder can be sent out</strong> via 
   Slack, Facebook, Twilio, or an internal company's application.

* I fell down and can't get up! The Amazon button has a loop so it can be warn at the end of a lanyard.

* Voting machine (what's for lunch?)
* Start the coffee maker from your bedstand

* Switch a smart light bulb on and off (party mode). 

   The Philips Hue light requires a hub.<br />
   <a target="_blank" href="https://www.lifx.com/">LIFX</a> bulbs do not.

* Mute TV without the delay of figuring which of 20 buttons to press on the remote
* Remote control home appliances
* Remote control Netflix
* Order your favorite pizza for delivery

* <a target="_blank" href="https://www.hackster.io/iotians/uber-cab-booking-3f8f30?ref=part&ref_id=13747&offset=11">
   Hail a Uber or Lyft car</a>

* <a target="_blank" href="https://www.youtube.com/watch?v=e1hmjyNwrCQ">
   Honk the horn on your Tesla</a> from inside your house

* <a target="_blank" href="https://www.hackster.io/pooja_baraskar/let-s-make-a-smartwatch-with-aws-iot-661fed">
   Make a smart watch with AWS IoT</a>


<a name="AWSIoTIntro"></a>

### Intro Lab #

Amazon has a free online self-paced lab on their 
<a target="_blank" href="https://qwiklabs.com/lab_catalogue">QwikLab platform</a> 
named
<a target="_blank" href="https://qwiklabs.com/searches/lab?keywords=Introduction%20to%20AWS%20Internet-of-Things">
Introduction to AWS Internet-of-Things (IoT)</a>
runs a simple therometer <strong>IoT device simulator</strong> on Amazon EC2 to 
generate and publish sample sensor data to an AWS device gateway. 
Skills taught include building a simple <strong>rule</strong> to permit 
publishing of a <strong>notification</strong> 
to an AWS SNS <strong>topic</strong> when the temperature of the device is greater than a defined threshold. 
Connecting an email address with the SNS topic results in an email notification when the threshold is met. 
The device <strong>shadow</strong> is then updated so the device will “turn on the air conditioning”, 
resulting in lowering temperatures.

The tutorial begins with obtaining a private SSH certificate (PEM for Mac, PPK for Windows) to login into an EC2 instance
using PuTTY in Windows or a Terminal command such as this on Mac:

   <tt><strong>
   ssh -i "mykey.pem" ec2-uer@ec2-12-12-123-123.compute-1.amazonaws.com
   </strong></tt>

Once in, the <strong>simulator</strong> in invoked and a certificate is created using a command that begins with:

   <pre><strong>
   aws iot create-keys-and-certificates --set-as-active \
   --certificate-pem-outfile certs/certificate.pem.crt \
   --public-key-outfile certs/public.pem.key \
   --private-key-outfile certs/private.pem.key \
   --region us-east-1
   </strong></pre>

PROTIP: Since the above command is done within Amazon's landscape,
it can automatically inform Amazon's IoT Resources database.
This is why it appears when you go to the IoT Resources site.

PROTIP: Amazon's IoT Button is authenticated a different way,
as <strong>a server</strong> 
with its own <strong>direct access</strong> to the public internet.


<a name="ButtonConfig"></a>

## Configure the IoT Button #

   <amp-img layout="responsive" alt="aws-iot-setup-v02-650x345-168kb.jpg" width="650" height="345" src="https://cloud.githubusercontent.com/assets/14143059/17956286/e8624550-6a45-11e6-9a88-6bb234d64f6e.jpg"></amp-img>

0. PROTIP: Know the SSID name and password to your regular network's WiFi because 
   the AWS Button is setup like another computer
   communicating directly to the public internet.
   

   ### Generate Thing certificates #

0. Login to Amazon's own IoT Resources Console at <br />
   <a target="_blank" href="https://console.aws.amazon.com/iot/home/">
   <strong>https://console.aws.amazon.com/iot/home</strong></a>

   <a target="_blank" href="https://console.aws.amazon.com/iot/home?region=us-east-1#/thing/">
   https://console.aws.amazon.com/iot/home?region=us-east-1#/thing/iotbutton_...</a>
   <amp-img width="650" height="262" alt="aws-iot things certs 20160811-650x262-i12.jpg" src="https://cloud.githubusercontent.com/assets/14143059/17599908/80361e52-5fbe-11e6-938c-fac589f6d563.jpg"></amp-img>

   <a name="Region"></a>

0. Select a location (region) from the upper right corner.
   Initially "N. Virginia" was the only region supporting Lambda.
   There is now:
   * US West (Oregon), EU (Ireland), EU (Frankfurt), Asia Pacific (Tokyo)
   * Jun 23, 2016, Sydney in  Asia Pacific 
   * Jul 25, 2016, Asia Pacific (Singapore)
   <br /><br />

0. Click "Create a resource" for the create panel.

   <amp-img alt="aws-iot-resources 20160804-650x80-i14.jpg" width="650" height="80" src="https://cloud.githubusercontent.com/assets/14143059/17656207/5cddb9c0-6274-11e6-9485-95122914ac0f.jpg"></amp-img>
   <br /><br />
   
   PROTIP: Remember these icons and what they mean because
   <a href="#ResourcePage">the Resources page</a> uses them without annotation.

0. Click "Create a thing".

   NOTE: Error messages appear on the lower left of the screen.

0. Specify a name such as "AWS-iot-button-01".

   PROTIP: Zero-pad numbers because you'll want more than one ;)

0. Click "Create" button for the black panel to open at the right.

   If the black part of the screen isn't visible, click the "?" on the right edge to expand it.

0. Click "Connect a device".
0. Check "NodeJS". The text on screen:

   First, you will need to create and download security credentials for your device. The following steps will help you to create and download security credentials (a certificate for authentication, and a policy that defines what the device using this certificate is allowed to do).

   You can generate a certificate with 1-click. When you generate a certificate, 
   we will also generate a default security policy named <strong>`iotbutton_G030......N0AV-Policy`</strong>. 
   You can modify this security policy at any time through the 'Resources' panel of this console.

0. Click "Generate certificate and policy".
0. Click "Download public key" to your Downloads folder.
0. Click "Download private key"
0. Click "Download certificate"
0. Click "Confirm &amp; start connecting".

   <a name="EndpointSubdomain"></a>

   An example:

   <pre>
{
  "host": "ABCDEFG1234567.iot.us-east-1.amazonaws.com",
  "port": 8883,
  "clientId": "iotbutton_G030....1N0AV",
  "thingName": "iotbutton_G030.....1N0AV",
  "caCert": "root-CA.crt",
  "clientCert": "427c7ac25f-certificate.pem.crt",
  "privateKey": "427c7ac25f-private.pem.key"
}
   </pre>

   NOTE: The first part of the host string (such as "ABCDEFG1234567") is the 
   <strong>Enpoint Subdomain</strong>.

   NOTE: Certificate file prefix 
   (example "427c7ac25f") will be different every time keys are generated.

0. Highlight the text on the screen and copy it. 

0. When you return to the Thing menu,
   notice that each certificate key appears above the hand icon.

   ### Resources page #

   Pressing the blue link to the right of "AWS IoT:" for the Resources screen:<br />
   <a target="_blank" href="https://console.aws.amazon.com/iot/home?region=us-east-1#/thing/">
   https://console.aws.amazon.com/iot/home?region=us-east-1#/thing/iotbutton_...</a>
   <amp-img width="650" height="262" alt="aws-iot things certs 20160811-650x262-i12.jpg" src="https://cloud.githubusercontent.com/assets/14143059/17599908/80361e52-5fbe-11e6-938c-fac589f6d563.jpg"></amp-img>

   PROTIP: To avoid error messages, deactivate before deletion.
   
   PROTIP: Check one item at a time to perform an Action.
   

   ### Configure Button #

   <a target="_blank" href="http://docs.aws.amazon.com/iot/latest/developerguide/configure-iot.html">
   Configure the AWS IoT Button</a> to use your Wi-Fi and these resources to connect to AWS securely:

0. To place the button into <strong>configuration mode</strong>, 
   press and hold the button down for 5 seconds until it 
   <a href="#LightColor">flashes blue</a>.

   This activates a small <strong>web server</strong> inside the button.

0. PROTIP: <a target="_blank" href="https://www.youtube.com/watch?v=rMiplPiU2nI&t=5m20s">
   One teardown video</a> found inside a Dash button a
   digital microphone (24-bit 12S 
   <a target="_blank" href="http://www.analog.com/media/en/technical-documentation/obsolete-data-sheets/ADMP441.pdf"> Analog Devices ADMP441</a>) used for <a target="_blank" href="http://www.blog.jay-greco.com/wp/?p=116">
   ultrasonic data transmisson during setup</a>.
   So do setup in a quiet place (away from music, fans, transformers in fishtanks, etc.).

0. Navigate to your computer's Network settings page, Open Network Preferences, 

   On a Mac, click the network icon on the top menu of icons.
   to the button's Wi-Fi network SSID shown, such as:

   <strong>Button ConfigureMe - 977</strong>

0. Configure your computer's Network settings 
   to the button's Wi-Fi network SSID shown.

0. Click "Show password" and type 
   the <strong>last 8 digits</strong> of the device serial number (such as "8351N0AV") 
   as the WPA2-PSK password. Click Join.

   <amp-img width="400" height="170" alt="aws iot rear_housing_wifi_password-400x170-i17.jpg" src="https://cloud.githubusercontent.com/assets/14143059/17655829/fd21028e-626f-11e6-9199-f2027ce8d25d.jpg"></amp-img>
   <br /><br />

0. Click the link<br />
   <a target="_blank" href="http://192.168.0.1/index.html">
   http://192.168.0.1/index.html</a> to open in new tab.

   <amp-img width="545" height="356" alt="aws-iot-button-wifi 20160813-545x356-i11.jpg" src="https://cloud.githubusercontent.com/assets/14143059/17656609/389ffbb8-6279-11e6-9b24-d6e609f6bd0a.jpg"></amp-img>
   <br /><br />

0. Enter your local network's Wi-Fi SSID and password.

   PROTIP: This means the Amazon IoT Button communications like another laptop computer,
   directly connected (exposed) to the public internet.

0. Click "Browse" next to Certificate and select the <strong>...-certificate.pem.crt</strong> file you just downloaded above.
0. Click "Browse" next to Private Key and select the <strong>...-private.pem.key</strong> file you just downloaded above.

0. Copy the <strong>Endpoint Subdomain</strong>  <a href="#EndpointSubdomain">from before</a>.

0. Copy the <strong>Endpoint Region</strong> from <a href="#Region">region selected before</a>.

0. Check the box to agree to the terms and conditions.
   This should result in an endpoint generated, such as:

   <tt>ABCDEFG1234567.iot.us-east-1.amazonaws.com</tt>

0. PROTIP: Copy the end-point generated for your device, such as:

   Save it in a text file along with the certificates.

0. Click "configure" (tiny button).


   ### WiFi Router #

0. This isn't mentioned on the Amazon page:
   Ignore it if get see a router page (such as "Dlink", etc.) such as:

   http://192.168.0.1/Status/Device_Info.shtml

   ### AWS IoT Websites #

   <img align="right" width="100" height="100" src="/images/aws-iot/Internet-Of-Things_AWSIoT.svg">
0. Make sure your browser can still connect to an external webpage, such as<br />
   <a target="_blank" href="https://aws.amazon.com/iot">
   <strong>https://aws.amazon.com/iot</strong></a>

   NOTE: The AWS IoT service is its own category among other AWS service groupings.

   <a target="_blank" href="https://aws.amazon.com/iot/getting-started">
   <strong>https://aws.amazon.com/iot/getting-started</strong></a><br />
   provides a list of URLs related to IoT.


   CONGRATULATIONS!

Now that you can connect to the internet with your "secret decoder ring", 
it's time you know its tremendous power.


<a name="WhyAmazon"></a>

## Why Amazon IoT? #

The real power of Amazon's IoT is that it is part of
the most popular cloud services for enterprises and others.

<amp-img alt="iot-aws-pub-sub 563x289-99kb" width="490" height="277" src="https://cloud.githubusercontent.com/assets/300046/17865916/c1794f3c-6861-11e6-969d-dd5b6657c503.jpg"></amp-img>
   This diagram <a href="#AWSIoTIntro">from Amazon's IoT Intro course</a>
   illustrates the loose coupling of components in Amazon's cloud.
   IoT devices publish <strong>telemetry data</strong> 
   to an <strong>IoT Topic</strong>.
   Topics notify its <strong>subscribers</strong> 
   when a <strong>trigger</strong> is identified by a
   <strong>IoT rule</strong>. Rules can trigger Amazon's other services.

* <a class="ulink" href="http://aws.amazon.com/lambda/" target="_blank">
   AWS Lambda</a>
   runs your NodeJs or Java code on virtual servers in response to events.

* <a class="ulink" href="http://aws.amazon.com/sns/" target="_blank">
   Amazon Simple Notification Service (SNS)</a>
   sends or receives notifications.

* <a class="ulink" href="http://aws.amazon.com/sqs/" target="_blank">
   Amazon Simple Queue Service (SQS)</a>
   stores data in a queue to be retrieved by applications.

* <a class="ulink" href="http://aws.amazon.com/s3/" target="_blank">
   Amazon Simple Storage Service (S3)</a>
   provides scalable storage in the AWS cloud.
   Assets in S3 can go into Amazon's distributed cloud CDN all over the world.

* <a class="ulink" href="http://aws.amazon.com/dynamodb/" target="_blank">
   Amazon DynamoDB</a>
   provides managed NoSQL databases (only) in Amazon's cloud.
   The management is provided by Amazon's RDS (Relational Database Service).

   QUESTION: Can rules send info to MySQL (Aurora) database instances?

* <a class="ulink" href="http://aws.amazon.com/kinesis/" target="_blank">
   Amazon Kinesis</a>
   enables real-time processing of streaming data at a massive scale. 

More importantly, its early start and popularity means AWS has become the most mature
of clouds, with the most experienced people who have learned how to work with it.

<a target="_blank" href="http://docs.aws.amazon.com/iot/latest/developerguide/iot-rule-actions.html">
AWS IoT Rule Actions</a>
lists code examples to interact with the services listed above.


## How the Button fits in #

<a target="_blank" href="http://docs.aws.amazon.com/iot/latest/developerguide/what-is-aws-iot.html">
This</a> provides a description of components described in the 
<a target="_blank" href="https://docs.aws.amazon.com/console/iot/quickstart">
Quickstart tutorial</a><br />
lists <a target="_blank" href="https://aws.amazon.com/iot/how-it-works/">
system components</a>:

<a target="_blank" title="awsiot-how-it-works_howitworks_1-26.png" href="https://cloud.githubusercontent.com/assets/14143059/17651526/5936d7be-6226-11e6-8338-450f68097d7a.png">
<img alt="awsiot-how-it-works_howitworks_1-26-650x381-i11.jpg" width="650" height="381" src="https://cloud.githubusercontent.com/assets/14143059/17651552/d195a654-6226-11e6-9650-f54baf414f72.jpg"></a>

We'll be describing how to work with each component below.
But for now, here's a techy overview of each component.

* <strong>Device gateway</strong>
   enables devices to securely and efficiently communicate with AWS IoT.
   It's especially needed when there are many devices at a location.

* <strong>Security and Identity service</strong>
   provides shared responsibility for security in the AWS cloud. Your things must keep their credentials safe in order to send data securely to the message broker. The message broker and rules engine use AWS security features to send data securely to devices or other AWS services.

* <strong>Message broker</strong>
   provides a secure mechanism for things and AWS IoT applications to publish and receive messages from each other. 
   
   PROTIP: To publish, use the HTTP REST interface with an Access Key ID and Secret Key from code developed using the SDK
   or from the AWS CLI or AWS Signature Version 4. Each ID would be associated with IAM users, groups, and roles.
   Alternately, sign-in via Facebook using Amazon Cognito Identity which generates temporary key pairs
   (Access Key ID and Secret Key).
   
   PROTIP: To publish and subscribe, use either the MQTT protocol directly or MQTT over WebSockets,
   using X.590 certificates.
   MQTT is more light-weight than HTTP.
   

* <strong>Rules engine</strong>
   provides message processing and integration with other AWS services. You can use a SQL-based language to select data from message payloads, process the data, and send the data to other services, such as Amazon S3, Amazon DynamoDB, and AWS Lambda. You can also use the message broker to republish messages to other subscribers.

* <strong>Thing registry</strong> (aka Device Registry) 
   organizes the resources associated with each thing. You register your things and associate up to <strong>three custom attributes</strong> with each thing. 
   Associate certificates and MQTT client IDs with each thing to improve management and troubleshooting of things.

   <a name="Shadows"></a>

   <img align="right" width="100" height="100" src="/images/aws-iot/Internet-Of-Things_AWSIoT_shadow.svg"><br />

* <strong>Thing shadow</strong>
   (aka device shadow) refers to a JSON document which stores the 
   <strong>current state</strong> information for a thing (device, app, and so on).
   Note this does NOT contain a history of past statuses (what others call a "digital twin").

   | icon | state |
   | :--- | :---- |
   | <img width="100" height="100" alt="desiredstate" src="/images/aws-iot/Internet-Of-Things_AWSIoT_desiredstate.svg"> | desiredstate |
   | <img width="100" height="100" alt="reportedstate" src="/images/aws-iot/Internet-Of-Things_AWSIoT_reportedstate.svg"> | reportedstate |

* <strong>Thing Shadows service</strong>
   provides persistent representations of things in the AWS cloud. 
   You can publish updated state information to a thing shadow, 
   and a thing can synchronize its state when it connects. 
   Things can also publish their current state to a thing shadow for use by applications or devices.

<hr />

<a name="Lambda"></a>

## Email on button click #

0. Get on the AWS Lambda console at<br />
   <a target="_blank" href="https://console.aws.amazon.com/lambda/home#/create/configure-triggers?bp=iot-button-email">
   <strong>https://console.aws.amazon.com/lambda/home#/create/configure-triggers?bp=iot-button-email</strong></a>

   The "configure-triggers?bp=iot-button-email" in the URL is 
   equivalent to going to the AWS Lambda console at<br />
   <a target="_blank" href="https://console.aws.amazon.com/lambda/home">
   https://console.aws.amazon.com/lambda/home</a>,
   click "Create a Lambda function", 
   click "Select blueprint", 
   then find and select "iot-button-email".
   Its description is "An AWS Lambda function that sends an email on the click of an IoT button.""

0. For IoT Type, select "IoT Button" (model JK76PL),

0. Type in Device Serial Number (DSN) 
   <strong>without spaces</strong> from the back of the device.


   <a name="RuleName"></a>

0. Type in Rule Name: "AWS-IoT-single-button-email".

   PROTIP: Use dashes instead of spaces. Specify the type of button pushed in the name (single, double, long).

0. Check <strong>Enable trigger</strong>.

0. Create a SQL statement:

   <pre><strong>
   SELECT * FROM 'iotbutton/+'
   </strong></pre>

0. Check "Enable trigger".
0. Click "Next".

0. Specify a function name such as <strong>`AWS-IoT-single-button-email`</strong>
   <a name="RuleName"></a>

0. For Description, enter something like "An AWS Lambda function that sends an email on the click of an IoT button.".
0. For Runtime, leave it "Node.js 4.3".

   QUESTION: Where to get Node script to email?

0. Replace "my_email" with the email address you want to :

   <pre>
   const EMAIL = 'my_email@example.com';  // TODO change me
   </pre>

0. Type a Role Name such as "IoT-AWS".

   WARNING: No spaces in Role Names.

0. Scroll down to "Role*" and select "Create new role from template(s)".

0. For Policy templates, select "AWS IoT Button permissions".

   PROTIP: From Permission definitions for templates detailed 
   <a target="_blan" href="https://docs.aws.amazon.com/lambda/latest/dg/policy-templates.html">
   here</a>, the AWS IoT Button permissions" are:

   <pre>
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "sns:ListSubscriptionsByTopic",
                "sns:CreateTopic",
                "sns:SetTopicAttributes",
                "sns:Subscribe",
                "sns:Publish"
            ],
            "Resource": "*"
        }
    ]
}
   </pre>

0. Click Next.


   ### Testing #

0. Return to this screen by logging into:<br />
   <a target="_blank" href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/functions/AWS-iot-button?tab=code">
   https://console.aws.amazon.com/lambda/home?region=us-east-1#/functions/AWS-iot-button?tab=code</a>
   <amp-img width="650" height="133" alt="aws-iot lambda button 20160807-650x133.png" src="https://cloud.githubusercontent.com/assets/300046/17464187/56a2699e-5c8d-11e6-8da6-6807be3ed714.jpg"></amp-img>
   <br /><br />

   PROTIP: A big question about many IoT devices is what happens when the network is not available.
   
   Does the device cache the user action for broacast later?

   Does the system store delayed transmissions with the time of user action rather than the time when data can be transmitted?

   PROTIP: Local storage is done by <strong>IoT Gateway</strong> servers
   which are also called fog nodes in a fog network.

   ### Amazon CloudWatch Settings #

0. Click Settings at the upper-right blue menu.
 
   NOTE: CloudWatch is disabled by default because 
   IAM permissions are needed.

   https://docs.aws.amazon.com/iot/latest/developerguide/cloud-watch-logs.html

0. Click Create a new role.
0. Type in a Role name that's unique, such as "custom_aws-iot-button-01".
0. Select the Debug log level initially.

<hr />

## SNS to SMS #

Alternatively, to send an SMS on DOUBLE tap.

0. Go to SNS in the AWS console and create a SNS topic.

0. Define the lambda function to send the SMS. 

0. Add a subscription to the topic For SMS delivery to a cell phone number.

See https://www.socialcustomer.com/2016/05/how-to-set-up-an-aws-iot-button.html


<hr />

### Additional things #

PROTIP: Once you get the Button working with one third-party API,
you can add context from additional sensors and use other APIs.

<a target="_blank" href="https://aws.amazon.com/iot/getting-started/#kits">
Other device starter kits</a> specifically for AWS include the
<a target="_blank" href="https://www.amazon.com/Intel%C2%AE-Edison-Grove-Starter-Powered/dp/B0168KU5FK?ie=UTF8&*Version*=1&*entries*=0">
$169 Intel Edison and Grove IoT Starter Kit Powered by AWS
from Seed</a> with sensors for indoor environments.

If you already have an Arduino board, not listed among <a target="_blank" href="https://aws.amazon.com/iot/getting-started/#kits">
Amazon's Start Kits</a> is the
<a target="_blank" href="https://www.amazon.com/Seeeduino-Cloud-Grove-Starter-Powered/dp/B01669BB60/">
$85 Seeed Starter from the Amazon Store</a>



<hr />

<a name="IFTTT"></a>

## IFTTT Maker #

Take this route on a LONG press of the Button.

IFTTT.com provides a user-interface to specify triggers and actions without programming.

0. Create your IFTTT Maker Channel at<br />
   <a target="_blank" href="https://ifttt.com/maker/">
   <strong>https://ifttt.com/maker</strong></a>

   Create an account if necessary. 

0. PROTIP: Copy your IFTTT Maker Channel Key and save it somewhere in a list of AWS IoT Dash buttons.

0. Create a recipie on<br />
   <a target="_blank" href="https://ifttt.com/myrecipes/personal">
   https://ifttt.com/myrecipes/personal</a>

0. Click "this".
0. Type "maker" in the Search Channels field.
0. Click on the Maker icon when it appears.
0. Click "Receive a Web Request".
0. Type in Event Name "AWS 1 SINGLE", then click "Create Trigger".

   PROTIP: Even if you have don't have more than one button, you may in the future.
   Use a black permanent marker to 
   write a large circled number to uniquely identify each button.

0. Click "that" (action).
0. Scroll to see all the possibilities, but pick one. In this example, 
   let's send a simple SMS text to your phone. 
0. Type "sms" in the Search field.
0. Click "SMS" (not "Android SMS").
0. Click "Send me an SMS".
0. Replace the sample message text with the following:

   <pre>
   AWS 1 SINGLE pressed. IFTTT Maker Channel {{EventName}} triggered.
   </pre>

   Note the "{{EventName}}" is substituted with what you typed in.

0. Click <strong>Create Action</strong>.

0. Short the sample Recipe Title to "AWS #1 SINGLE Press", then click <strong>Create Recipe</strong>.

0. Optionally, repeat the above steps to create recipies for DOUBLE and LONG instead of SINGLE press.


   <a name="IFTTT-Forward"></a>

   ### Lambda to IFTTT Forwarder #

   Create a Lambda function to forward events from your button to IFTTT. 
   Create a new Lamdba resource named "AWSIoTButton" and add the following code to it:

0. Get on the Amazon Lambda console for your region at<br />
   <a target="_blank" href="https://console.aws.amazon.com/lambda/">
   https://console.aws.amazon.com/lambda</a>
0. Click "Create a Lambda function".
0. Scroll down among blueprints to click "Skip".
0. Click the dotted line box to select.

0. Type in Rule Name: <strong>AWS IoT to IFTT</strong>.
0. For SQL statement: TODO?
0. Click "Enable trigger".

0. In the Configure function page, type (with no spaces) a Name such as "AWS-IoT-to-IFTT".
0. For Runtime, leave it "Node.js 4.3".
0. Highlight the whole code inline window to erase it, then copy this and paste it:

   <pre>
AWS.config.update({region:'us-east-1'});
var IFTTTkey = "<em>YOUR KEY here</em>";
var request = require('request');
&nbsp;
//this is called when the AWS Button is pressed and event data is passed as well
exports.handler = function(event, context) {
    console.log("Received AWS Button event: " + event.clickType + ". Firing IFTTT Maker Trigger...");
    request('https://maker.ifttt.com/trigger/' + 'AWS-'+ buttonState + '/with/key/' + IFTTTkey, function (error, response, body) {
        console.log("Complete! Response: ", response.statusCode);
    }
)};
   </pre>

0. Replace "<em>YOUR KEY here</em>" with your key shown <a href="#IFTTT">above</a>.
0. In Role, click "Choose and existing role" to "Select new role from template(s)".
0. In Role Name, type "AWS-IoT-to-IFTT".
0. In Policy templates, select "AWS IoT Button permission".
0. Click Next.
0. Click Finish.

0. In the <a target="_blank" href="https://console.aws.amazon.com/iot/home/">
   AWS IoT Dashboard https://console.aws.amazon.com/iot/</a>
   click the ENABLED item named "iotbutton_..."Rule. 
0. In the right pane, click "Lambda Action".
0. Select the "AWS-io-button" function we created earlier.

0. You can leave the first SNS function or remove it if you choose.


<hr />

### Manual Test cases #

When you click the AWS Dash IoT button, it sends a signal through your wi-fi,
over the public internet, and into the AWS cloud.

   The AWS Dash IoT device recognizes 3 click types:

   * SINGLE
   * DOUBLE (press the button twice in quick succession)
   * A LONG clickType is when the first press lasts longer than <strong>1.5 seconds</strong>. 
   <br /><br />

0. Click the button once.

0. Click the button twice quickly.

0. Hold down the button.

   <a name="LightColor"></a>

   ### Color of lights #

   | Color | Meaning |
   | ----- | ------- |
   | Solid Orange | No Wi-Fi configured |
   | Blinking Orange | Pre-DHCP error occurred |
   | Blinking Red | Post-DHCP error occurred |
   | Blinking White | Connecting to Wi-Fi, getting IP address, connecting to AWS IoT |
   | Blinking Blue | Soft AP mode |
   | Solid Green | Successfully connected to Wi-Fi and published a message to AWS IoT |
   | Pulsing Color (rcoybgmp) | AWS IoT Shadow User defined Sequence |
   | Pulsing Red | Battery Low |
   | Solid Red | Battery Dead |
   | Solid Red | Fatal internal error occured |

   ### Blinking pattern #

   | Blinking pattern | Error |
   | ---------------- | ----- |
   | Short short short | There was an error connecting to the configured wireless network. |
   | Short short long | There was an error obtaining an IP address from the network. |
   | Short long short | There was an error performing the host name lookup. This can be the result of not being able to reach the DNS server or an incorrectly configured AWS IoT endpoint subdomain. |
   | Short long long | Cannot connect to AWS IoT. This can be an issue with the network, but is most likely not an issue with the certificates.|
   | Long short short | Cannot establish a secure connection with the server. This error is most likely due to an unknown or inactive certificate. |
   | Long short long | Received HTTP 403 Forbidden This error is most likely returned because the certificate does not have permission to publish to that topic.|
   | Long long short | There is a problem sending to or receiving from AWS IoT. This is most likely just a networking error.|
   | Long long long | Received an unknown HTTP response from AWS IoT. |


   ### Examine CloudWatch Logs #

TBD:

<hr />

## Losant IoT Cloud #

https://www.losant.com/blog/getting-started-with-aws-iot-button-losant

<hr />

## Samsung ARTIK Cloud #

Samsung provides a vendor-neutral cloud service.

0. Begin from <a target="_blank" href="https://artik.cloud/my/new_device">
   https://artik.cloud/my/new_device</a>

0. Select "Amazon Dash Button Proxy".

   Samsung defines a "Proxy" as "Software running on an always-on computer on the local network of the device".

   https://artik.cloud/works-with

0. Click "Connect device".

0. Click the name you assigned for a chart menu.

0. Click "ButtonPressed" for charts about it at https://artik.cloud/my/data



<a name="Rules"></a>

## Rules #

<img align="right" width="100" height="100" alt="rule" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_rule.svg">
https://docs.aws.amazon.com/console/iot/rules
Rules Engine
provides the logical thinking 

<img align="right" width="100" height="100" alt="action" src="/images/aws-iot/Internet-Of-Things_AWSIoT_action.svg">
https://docs.aws.amazon.com/console/iot/rules/create-rule
actions

control unit publishes commands

   A sample rules which are SQL syntax commands:

   <pre>
   SELECT * FROM 'iotbutton/+' WHERE state='ERROR'
   </pre>

   NOTE that standard single quotes are used, not the left and right leaning ones.

## Simulator #

<img width="100" height="100" alt="simulator"
src="/images/aws-iot/Internet-Of-Things_AWSIoT_simulator.svg">

https://aws.amazon.com/blogs/iot/device-simulation-with-aws-iot-and-aws-lambda/


## SDK #

https://aws.amazon.com/iot/sdk/

available in several programming languages.


### Things (Devices) #

The breath of Things imagined from the zip file downloaded from <a target="_blank" href="https://aws.amazon.com/architecture/icons/">
Amazon's Icons page</a>:

<table border="0" cellpadding="0" cellspacing="0">
<tr valign="top"><td align="center">
   <img width="100" height="100" alt="sensor" src="/images/aws-iot/Internet-Of-Things_AWSIoT_sensor.svg"><br />sensor
</td><td align="center">
   <img width="100" height="100" alt="servo" 
   src="/images/aws-iot/Internet-Of-Things_AWSIoT_servo.svg"><br />servo
   </td></tr>

<tr valign="top"><td align="center">
   <img width="100" height="100" alt="topic" 
   src="/images/aws-iot/Internet-Of-Things_AWSIoT_topic.svg"><br />topic
</td><td align="center">
   <img width="100" height="100" alt="thingbank" 
   src="/images/aws-iot/Internet-Of-Things_AWSIoT_thingbank.svg"><br />bank
</td><td align="center">
   <img width="100" height="100" alt="thinggeneric" 
   src="/images/aws-iot/Internet-Of-Things_AWSIoT_thinggeneric.svg"><br />
   generic
   </td></tr>

<tr valign="top"><td align="center">
<img width="100" height="100" alt="thingbifactory" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thingfactory.svg"><br />
factory
</td><td align="center">
<img width="100" height="100" alt="thingutility" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thingutility.svg"><br />
   utility
</td><td align="center">
<img width="100" height="100" alt="medicalemergency" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thingmedicalemergency.svg"><br />
   medical<br />emergency
</td><td align="center">
<img width="100" height="100" alt="policeemergency" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thingpoliceemergency.svg"><br />
police<br />emergency
   </td></tr>

<tr valign="top"><td align="center">
<img width="100" height="100" alt="thingbicycle" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thingbicycle.svg"><br />
bicyle
</td><td align="center">
<img width="100" height="100" alt="thingbicar" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thingcar.svg"><br />
car
</td><td align="center">
<img width="100" height="100" alt="travel" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thingtravel.svg"><br />
travel
   </td></tr>

<tr valign="top"><td align="center">
<img width="100" height="100" alt="thinghouse" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thinghouse.svg"><br />
house
</td><td align="center">
<img width="100" height="100" alt="thinglightbulb" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thinglightbulb.svg"><br />
lightbulb
</td><td align="center">
<img width="100" height="100" alt="thermostat" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thingthermostat.svg"><br />
thermostat
</td><td align="center">
<img width="100" height="100" alt="windfarm" 
src="/images/aws-iot/Internet-Of-Things_AWSIoT_thingwindfarm.svg"><br />
windfarm
   </td></tr>
</table>

The two standards bodies in IoT are the Thread Group
(formed by ARM, Samsung, Qualcomm, and Google Nest)
and OCF (Open Connectivity Foundation), 
formerly the OIC (Open Interconnect Consortium) and 
the Microsoft-backed AllSeen Alliance.

Microsoft earlier released its open-source IoTivity bridge 
to connect OIC tools
with the AllSeen Alliance's AllJoyn APIs to talk to OIC-compatible IoT devices.


<a name="Protocols"></a>

## Protocols #

One distinguishing character of each device is the networking protocol it uses.

<table border="1" cellpadding="4" cellspacing="0">
<tr valign="center"><td>
   <img width="100" height="100" alt="MQTTprotocol" src="/images/aws-iot/Internet-Of-Things_AWSIoT_MQTTprotocol.svg">
   </td><td>
   <a target="_blank" href="https://docs.aws.amazon.com/iot/latest/developerguide/protocols.html">
   MQTT is AWS's protocol of choice</a>
   is 30 years old but is fault tolerant, has small footprint, and efficient in bandwidth.
   AWS GM says in <a target="_blank" href="https://www.youtube.com/watch?v=N3-Az0OH5WM&t=2m34s">this video</a>.
   <a target="_blank" href="https://github.com/awslabs/aws-iot-examples/tree/master/mqttSample">
   See the MQTT NodeJs sample project</a>.
</td></tr>
<tr valign="center"><td>
   <img width="100" height="100" alt="HTTPprotocol" src="/images/aws-iot/Internet-Of-Things_AWSIoT_HTTPprotocol.svg">
   </td><td>
   HTTP
</td></tr>
<tr valign="center"><td>
   <img width="100" height="100" alt="HTTP2protocol" src="/images/aws-iot/Internet-Of-Things_AWSIoT_HTTP2protocol.svg">
   </td><td>
   HTTP2
</td></tr>
</table>


<a target="_blank" href="http://docs.aws.amazon.com/iot/latest/developerguide/protocols.html">
More on MQTT and HTTP protocols</a>

   <tt>
   <em>AWS IoT Endpoint</em>/topics/<em>url_encoded_topic_name</em>?qos=1
   </tt>

A sample WebSockets:

   <tt>
   wss://<em>endpoint</em>.iot.<em>region</em>.amazonaws.com/mqtt
   </tt>

BTW, Amazon does not yet support other protocols used with IoT such as 
<a target="_blank" href="http://coap.technology/">
CoAP</a> the Constrained Application Protocol defined as
<a target="_blank" href="http://coap.technology/spec.html">
RFC 7252</a>.
It was designed to carry REST calls for 
machine-to-machine (M2M) applications such as smart energy and building automation.
It can accept XML, JSON, and a derivative of JSON for taggable binary without Base64 encoding,
called <a target="_blank" href="http://cbor.io/">
COBR</a> Concise Binary Object Representation defined as
<a target="_blank" href="http://cbor.io/spec.html">
RFC 7049</a>.


## SDK #

The first page of the <a target="_blank" href="http://docs.aws.amazon.com/iot/latest/developerguide/what-is-aws-iot.html">
AWS IoT Developer Guide</a> has this diagram:

   <amp-img alt="aws_iot_data_services 20160820-650x289-47kb.jpg" width="650" height="289" src="https://cloud.githubusercontent.com/assets/300046/17834560/1cb09514-6703-11e6-85cd-f61849826661.jpg"></amp-img>


   PROTIP: You do not need to Click to Download the AWS IoT Node.js SDK
   (file <strong>aws-iot-device-sdk-js-latest.zip</strong>) at<br />
   <a target="_blank" href="https://github.com/aws/aws-iot-device-sdk-js/blob/master/README.md">
   https://github.com/aws/aws-iot-device-sdk-js</a><br />
   because most developers obtain the SDK by using the Node Package Manager
   which detects and updates versions:

   <tt><strong>
   npm install aws-iot-device-sdk
   </strong></tt>

   This contains a gulpfile.js and a package.json file for implementation by NPM.
   That means the Gulp app needs to be installed as well.


## Acronyms #

PAC = programmable automation controllers (for local "Edge computing")

QUESTION: Connect to leading SCADA gateways of Schneider, Honeywell, etc.﻿


## Social Media #

https://aws.amazon.com/blogs/iot/

links to https://aws.amazon.com/about-aws/events/

Articles about this:

* http://www.computerworld.com/article/3102846/internet-of-things/internet-of-things-early-adopters-share-4-key-takeaways.html

* https://industrial-iot.com/2016/08/infor-announces-iot-platform-inforum-2016/

* http://searchaws.techtarget.com/tip/Push-the-AWS-IoT-Button-for-noncritical-tasks

* http://www.slideshare.net/AmazonWebServices/getting-started-with-aws-iot-september-2016-webinar-series

* https://www.youtube.com/watch?v=rMUOl-JWcVQ

* https://www.youtube.com/watch?v=i0ifCaPUhvo
   AWS IoT Button (2nd Generation) Testing! Feb 4, 2017

* https://www.youtube.com/watch?v=oIPsQhStbnY
   How to configure an AWS IoT Button

* https://www.youtube.com/watch?v=6sLd1MK2CbY
   Using an AWS IoT button to get your kids to show up for dinner
   Julien Simon


## More on IoT #

This is one of a series on IoT:

{% include iot_links.html %}
