---
layout: post
title: "Pact Testing (of APIs)"
excerpt: "Verify equivalance of twins vs. real services"
tags: [API, devops, evaluation]
filename: pact.md
image:
  feature: https://cloud.githubusercontent.com/assets/300046/14612210/373cb4e2-0553-11e6-8a1a-4b5e1dabe181.jpg
  credit: And Beyond
  creditlink: http://www.andbeyond.com/chile/places-to-go/easter-island.htm
comments: true
---
<i>{{ page.excerpt }}</i>

Pact (at <a target="_blank" href="https://docs.pact.io/">https://docs.pact.io</a>) is a testing library useful for creating and executing integration tests on microservices. It determines whether Test Doubles (mocks) of microservices are a valid stand-in for the real service. 

It's open source, owned by the Pact Foundation at <a target="_blank" href="https://github.com/pact-foundation">https://github.com/pact-foundation</a>

Pact provides a fluent API for service consumers to define the HTTP requests they will make to a service provider and the HTTP responses they expect back. [15:09] "Pastel's Law" -- stict in what is sent out, but responses allow extra keys for different consumers.

These are called consumer driven contracts (CDCs).
A Contract is a collection of agreements between a client (Consumer) and an API (Provider) that describes the interactions that can take place between them.

Consumer Driven Contracts is a pattern for software development that drives the development of the Provider from its Consumers' point of view.

   * Ian Robinson of Thoughtworks <a target="_blank" href="https://martinfowler.com/articles/consumerDrivenContracts.html">describes Consumer Driven Contracts: A Service Evolution Pattern</a>.
   <br /><br />

Pact is a word (not an acronym) for 
a family of frameworks to verify whether Consumer Driven Contracts are actually satisfied by the collaborating services built. 


## Test separately

<a target="_blank" href="https://dius.com.au/2016/10/19/scaling-organisations-with-microservices-and-contract-testing/">
NOTE</a>: Pact splits integration tests into separate unit tests.

![pact-diagram-650x296-28239](https://user-images.githubusercontent.com/300046/32830542-5e5be0d0-c9aa-11e7-88a0-0177cf2a6cec.jpg)


<!-- bskurrie@dius.com.au -->
Beth Skurrie (@bethesque, of Melbourne, Victoria) explains
in <a target="_blank" href="https://www.infoq.com/presentations/pact"> this [26:37] video on Sep 04, 2015</a> at [9:32] "Pact mocks the provider when it the consumer makes calls and handles responses correctly. [9:45] While consumer tests are running, the interactions is recorded into a Pact file as a contract. That file is then used to interact with the real provider to ensure "test symmetry" that mock and real providers work the same way.

The process also supports the inverse scenario.

   * uses her experience on
   https://github.com/realestate-com-au/pact 



Harry Winser <!-- Harry.Winser@rightmove.co.uk -->
(<a target="_blank" href="https://twitter.com/hazz223">@hazz223</a>, 
Pact Broker author), in <a target="_blank" href="https://vimeo.com/239429848">
VIDEO: Consumer Driven Contract Testing with Pact and Docker</a> 18 Oct 2017
illustrates the flow of work in a Pact service [13:05]
![pact-test-flow-616x327-22025](https://user-images.githubusercontent.com/300046/32812121-3f1cbe62-c958-11e7-9747-8eee74a592c3.jpg)

[12:19] shows that Pact Provider contract tests can also be used in QA and Staging.
![pact-in-pipeline-567x250-18831](https://user-images.githubusercontent.com/300046/32812053-e1cf182c-c957-11e7-8cc8-3e92250979a5.jpg)
[19:09]

[15:20] Consumer tests 
![pact-consumer-tests-650x362-27115](https://user-images.githubusercontent.com/300046/32812310-29a642f0-c959-11e7-955a-cf77dcf87632.jpg)

[20:03] Docker


## Network Graph from Broker

[15:30] Pact Broker 
Like Google, the Pact Broker can mine the data, to automatically generate a graph of relationships between services (who calls whom).

![pact-network-graph-654x513.jpg](https://user-images.githubusercontent.com/300046/32830073-eab9168a-c9a8-11e7-9e76-b2cd0208dd8b.jpg)


## Install server

Pact is available in multiple languages (Java, Scala, Groovy, Ruby, .NET, Swift, JS and Golang).

1. Install Docker
2. Instantiate a Postgress database.
3. Look at https://github.com/DiUS/pact_broker-docker
4. Instantiate a container using the Docker image at https://hub.docker.com/r/dius/pact-broker/tags/

   <pre><strong>
    docker pull dius/pact-broker
   </strong></pre>

5. Start Docker image

   docker run -d -p 80:80 pact-broker


## Setup



## Sample Pact exchange

PROTIP: Contracts are readable by software.

[11:04] Arrange, Pact, and Assert

   <pre>
Pact.service_consumer "Zoo App" do
  has_pact_with "Animal Service" do
    mock_service :animal_service do
      port 1234
    end
  end
end
   </pre>

Contract types:

* Preconditions ("You must be this tall to ride")
* Postconditions (e=mc^2)
* Variants

## Version

Combinatorial: 3 classses x 4 code paths each (4 * 4 * 4) = 64 tests

Changing a published API over time is hard due to backward compatibility concerns. This is even more of an issue in a microservice architecture with 100's of microservices that each publish an API. 

Consumer Driven Contracts is an effective service evolution pattern. 
when implemented in Spring Cloud Contract.


## References

Ruby Pact wiki: github.com/realestate-com-au/pact/wiki

<a target="_blank" href="https://codefresh.io/blog/how-to-test-microservice-integration-with-pact/">
How to Test Microservice Integration with Pact</a> 9 Oct 2017
by Anton Weiss 

https://app.pluralsight.com/library/courses/code-contracts/table-of-contents
Code Contracts</a> 1h 51m video course released 17 Jul 2012
by John Sonmez
provides an introduction to Code Contracts in the Microsoft .NET Framework.

Martin Fowler on Microservice Testing (
http://martinfowler.com/articles/microservice-testing/#definition
Article)

Introduction to consumer-driven contracts with Pact (http://dius.com.au/2016/02/03/microservices-pact/
Article)

Deploy with Confidence! - Ron Holshausen (https://www.youtube.com/watch?v=h-79QmIV824
Video April 6, 2016.

Integrated tests are a scam - J.B. Rainsberger (https://vimeo.com/80533536
Video / http://blog.thecodewhisperer.com/permalink/integrated-tests-are-a-scam
Article)

Verifying Microservice Integrations with Contract Testing - Atlassian (https://www.youtube.com/watch?v=-6x6XBDf9sQ&feature=youtu.be
Video)


Escape the integration syrup with contract tests by Stefan Smith (<a target="_blank" href="https://www.youtube.com/watch?v=NAF7HWW_eJs">[45:11]
Video at Agile on the Beach 2015</a>


https://www.youtube.com/watch?v=MDydAqL4mYE
Consumer Driven Contracts and Your Microservice Architecture</a> [51:01]
at Devoxx 
by Marcin Grzejszczak and Josh Long (at Pivotal).

https://www.youtube.com/watch?v=sAAklvxmPmk&t=540s
by Marcin Grzejszczak 

https://www.youtube.com/watch?v=iyNzYOcuU4I
2017-01 Consumer Driven Contracts with Spring Cloud Contract
presented in Toronto Jan 27, 2017 by Adib Saikali 

Pact JVM Library <a target="_blank" href="https://github.com/DiUS/pact-jvm">
https://github.com/DiUS/pact-jvm</a>


## Social

Twitter: <a targt="_blank" href="https://twitter.com/pact_up">@pact_up</a>
<a targt="_blank" href="https://twitter.com/contract-tests">#contract-tests</a>

Gitter: Join the chat at https://gitter.im/realestate-com-au/pact
where Beth talks with Kevin Meiresonne, dengayevskiy, etc.

Stackoverflow: ruby pact questions or general pact questions

Google users group: for ongoing discussions rather than questions


## More

{% include api_links.html %}

