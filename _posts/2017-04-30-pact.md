---
layout: post
title: "Pact Testing (of APIs)"
excerpt: "Verify equivalance of twins vs. real services"
tags: [API, devops, evaluation]
filename: pact.md
image:
  feature: https://cloud.githubusercontent.com/assets/300046/14612210/373cb4e2-0553-11e6-8a1a-4b5e1dabe181.jpg
  credit: And Beyond
  creditlink: http://www.andbeyond.com/chile/places-to-go/easter-island.htm
comments: true
---
<i>{{ page.excerpt }}</i>

Pact (at <a target="_blank" href="https://docs.pact.io/">https://docs.pact.io</a>) is a testing library useful for creating and executing integration tests on microservices. It determines whether Test Doubles (mocks) of microservices are a valid stand-in for the real service. 

Pact is a word (not an acronym) for 
a family of frameworks to verify whether Consumer Driven Contracts are actually satisfied by the collaborating services built. 

Pact software is available in multiple programming languages through several organizations:

   * Pact Go: https://github.com/pact-foundation/pact-go
   * Pact.js: https://github.com/pact-foundation/pact-js
   * Pact Python: https://github.com/pact-foundation/pact-python

   * Ruby Pact: https://github.com/realestate-com-au/pact
   * Pact Swift: https://github.com/DiUS/pact-consumer-swift
   * JVM Pact: https://github.com/DiUS/pact-jvm

   * .Net C# Pact: https://github.com/SEEK-Jobs/pact-net
   <br /><br />

These implement the Pact specification (in JSON) defined by the Pact Foundation at <a target="_blank" href="https://github.com/pact-foundation/pact-specification">https://github.com/pact-foundation/pact-specification</a>.

Pact provides a fluent API for service consumers to define the HTTP requests they will make to a service provider and the HTTP responses they expect back. [15:09] "Pastel's Law" -- stict in what is sent out, but responses allow extra keys for different consumers.

These are called consumer driven contracts (CDCs).
A Contract is a collection of agreements between a client (Consumer) and an API (Provider) that describes the interactions that can take place between them.

Consumer Driven Contracts is a pattern for software development that drives the development of the Provider from its Consumers' point of view.

   * Ian Robinson of Thoughtworks <a target="_blank" href="https://martinfowler.com/articles/consumerDrivenContracts.html">describes Consumer Driven Contracts: A Service Evolution Pattern</a>. Since then the industry has advanced beyond Schemas and XML to JSON.
   <br /><br />

consumer team assumed the API would be based on posting a JSON document (it was being invoked from a web browser), while the provider team implemented an application/x-www-form-urlencoded POST API.

## Test separately

<a target="_blank" href="https://dius.com.au/2016/10/19/scaling-organisations-with-microservices-and-contract-testing/">
NOTE</a>: The genius behind Pact is that it splits integration tests into separate unit tests.

![pact-diagram-1010x652-61431](https://user-images.githubusercontent.com/300046/32854858-d55fea92-c9f4-11e7-8dc7-4962bad24736.png)
[<a target="_blank" href="https://drive.google.com/open?id=1hFqEg7zs9N6V04xNT3vzdreCE_F5tuEd">.pptx</a>]

<!-- bskurrie@dius.com.au -->
Beth Skurrie (@bethesque, of Melbourne, Victoria and https://github.com/realestate-com-au/pact ) explains in <a target="_blank" href="https://www.infoq.com/presentations/pact"> a [26:37] video on Sep 04, 2015</a> at [9:32] says "Pact mocks the provider when it the consumer makes calls and handles responses correctly. [9:45] While consumer tests are running, the interactions is recorded into a Pact file as a contract. That file is then used to interact with the real provider to ensure <strong>"test symmetry"</strong> that mock and real providers work the same way.

The process also supports the inverse scenario.

The advantage of this approach is that because only one component is being tested at a time, failures are easier to identify.


## Pact Broker

Harry Winser <!-- Harry.Winser@rightmove.co.uk -->
(<a target="_blank" href="https://twitter.com/hazz223">@hazz223</a>, 
Pact Broker author), in <a target="_blank" href="https://vimeo.com/239429848">
VIDEO: Consumer Driven Contract Testing with Pact and Docker</a> 18 Oct 2017
illustrates the flow of work in a Pact service [13:05]
![pact-test-flow-616x327-22025](https://user-images.githubusercontent.com/300046/32812121-3f1cbe62-c958-11e7-9747-8eee74a592c3.jpg)

[12:19] shows that Pact Provider contract tests can also be used in QA and Staging.
![pact-in-pipeline-567x250-18831](https://user-images.githubusercontent.com/300046/32812053-e1cf182c-c957-11e7-8cc8-3e92250979a5.jpg)
[19:09]

[15:20] Consumer tests 
![pact-consumer-tests-650x362-27115](https://user-images.githubusercontent.com/300046/32812310-29a642f0-c959-11e7-955a-cf77dcf87632.jpg)

[20:03] Docker


### Network Graph from Broker

[15:30] Because the Pact Broker knows about traffic,
like Google, the Pact Broker can mine the data, to automatically generate a graph of relationships between services (who calls whom).

![pact-network-graph-654x513.jpg](https://user-images.githubusercontent.com/300046/32830073-eab9168a-c9a8-11e7-9e76-b2cd0208dd8b.jpg)


## Install server


1. Install Docker
2. Instantiate a Postgress database.
3. Look at https://github.com/DiUS/pact_broker-docker
4. Instantiate a container using the Docker image at https://hub.docker.com/r/dius/pact-broker/tags/

   <pre><strong>
    docker pull dius/pact-broker
   </strong></pre>

5. Start Docker image:

   docker run -d -p 80:80 pact-broker

0. Re-run



## Sample Pact exchange

First of all, if the consumer assumes the API would be based on posting a JSON document (being invoked from a web browser), make sure that the provider is not implemented using an `application/x-www-form-urlencoded` POST API.

Development of the interaction starts from the consumer side, with a test that at first fails until code is written to make the test pass (TDD here).

This contract is then provided to the Provider team to implement the provider service to fulfill the contract.

PROTIP: Contracts are readable by both people and software.

[11:04] Arrange, Pact, and Assert

This DSL from <a target="_blank" href="https://github.com/pact-foundation/pact-specification/tree/master/implementation-guidelines">Guidelines</a>:

   <pre>
Pact.service_consumer "Zoo App" do
  has_pact_with "Animal Service" do
    mock_service :animal_service do
      port 1234
    end
  end
end
   </pre>

Contract types:

* Preconditions ("You must be this tall to ride")
* Postconditions (e=mc^2)
* Variants


https://gist.github.com/bethesque/9d81f21d6f77650811f4
You will need ruby or the standalone mock service to run these examples.

   gem install pact-mock_service

   pact-mock-service help start


## Pastel's Law



## Versioning Backward Compatibility

Changing a published API over time is risky due to backward compatibility concerns. This is even more of an issue in a microservice architecture with 100's of microservices that each publish an API. 

<a target="_blank" href="http://rea.tech/enter-the-pact-matrix-or-how-to-decouple-the-release-cycles-of-your-microservices/">
This blog posted December 5, 2014</a> by Beth Skurrie describes this "Pact Matrix": 

<table border="1">
<tr align="left"><th> - </th><th> Consumer Head (pact) </th><th> Consumer Prod (pact) </th></tr>
<tr valign="top"><td> Provider Head  (codebase) </td><td> Contract tests </td><td> Contract tests<br />(ensure provider is backwards compatible) </td></tr>
<tr valign="top"><td> Provider Prod (codebase) </td><td> Contract tests<br />(ensure consumer is backwards compatible) </td><td> Already tested </td></tr>
</table>

Consumer Driven Contracts can be an effective service evolution pattern if ...
(implemented in Spring Cloud Contract).

Combinatorial: 3 classses x 4 code paths each (4 * 4 * 4) = 64 tests


## References

Ruby Pact wiki: github.com/realestate-com-au/pact/wiki

<a target="_blank" href="https://codefresh.io/blog/how-to-test-microservice-integration-with-pact/">
How to Test Microservice Integration with Pact</a> 9 Oct 2017
by Anton Weiss 

<a target="_blank" href="https://dius.com.au/2016/02/03/microservices-pact/">
Pact 101 â€“ Getting started with Pact and Consumer Driven Contract Testing
blog 03/02/2016</a>
By Ron Holshausen 

https://app.pluralsight.com/library/courses/code-contracts/table-of-contents
Code Contracts</a> 1h 51m video course released 17 Jul 2012
by John Sonmez
provides an introduction to Code Contracts in the Microsoft .NET Framework.

Martin Fowler on Microservice Testing (
http://martinfowler.com/articles/microservice-testing/#definition
Article)

Introduction to consumer-driven contracts with Pact (http://dius.com.au/2016/02/03/microservices-pact/
Article)

Deploy with Confidence! - Ron Holshausen (https://www.youtube.com/watch?v=h-79QmIV824
Video April 6, 2016.

Integrated tests are a scam - J.B. Rainsberger (https://vimeo.com/80533536
Video / http://blog.thecodewhisperer.com/permalink/integrated-tests-are-a-scam
Article)

Verifying Microservice Integrations with Contract Testing - Atlassian (https://www.youtube.com/watch?v=-6x6XBDf9sQ&feature=youtu.be
Video)


Escape the integration syrup with contract tests by Stefan Smith (<a target="_blank" href="https://www.youtube.com/watch?v=NAF7HWW_eJs">[45:11]
Video at Agile on the Beach 2015</a>


https://www.youtube.com/watch?v=MDydAqL4mYE
Consumer Driven Contracts and Your Microservice Architecture</a> [51:01]
at Devoxx 
by Marcin Grzejszczak and Josh Long (at Pivotal).

https://www.youtube.com/watch?v=sAAklvxmPmk&t=540s
by Marcin Grzejszczak 

https://www.youtube.com/watch?v=iyNzYOcuU4I
2017-01 Consumer Driven Contracts with Spring Cloud Contract
presented in Toronto Jan 27, 2017 by Adib Saikali 


## Social

Twitter: <a targt="_blank" href="https://twitter.com/pact_up">@pact_up</a>
<a targt="_blank" href="https://twitter.com/contract-tests">#contract-tests</a>

Gitter: Join the chat at https://gitter.im/realestate-com-au/pact
where Beth talks with Kevin Meiresonne, dengayevskiy, etc.

Stackoverflow: https://stackoverflow.com/questions/tagged/pact
ruby pact questions or general pact questions

<a target="_blank" href="
https://groups.google.com/forum/#!forum/pact-dev">
https://groups.google.com/forum/#!forum/pact-dev</a>
Google users group: for ongoing discussions rather than questions

## More

{% include api_links.html %}

